<div class="p-4">
        <h2>Wearable Management</h2>
        <div class="card p-3 mb-4">
          <ul class="nav nav-tabs" id="wearableTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab">Connected Devices</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">Configuration</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab">Status & Analytics</button></li>
          </ul>
          <div class="tab-content mt-3" id="wearableTabContent">
            <div class="tab-pane fade show active" id="devices" role="tabpanel">
              <h5>Connected Devices</h5>
              <form class="row mb-3" method="get" action="/admin/wearable-management"><div class="col-md-3"><input type="text" class="form-control" name="q" value="<%= q || '' %>" placeholder="Search by User ID or Device"></div><div class="col-md-3"><select class="form-select" name="type"><option value="">All Devices</option><option value="google-fit" <%= type==='google-fit'?'selected':'' %>>Google Fit</option><option value="healthkit" <%= type==='healthkit'?'selected':'' %>>Apple HealthKit</option></select></div><div class="col-md-3"><button class="btn btn-outline-primary w-100" type="submit">Filter</button></div><div class="col-md-3"><button class="btn btn-primary w-100" type="button" data-bs-toggle="modal" data-bs-target="#addDeviceModal">Connect New Device</button></div></form>
              <div class="table-responsive"><table class="table table-striped"><thead><tr><th>User ID</th><th>Device Type</th><th>Device ID</th><th>Status</th><th>Last Sync</th><th>Actions</th></tr></thead><tbody>
                <% (devices || []).forEach(d => { %>
                  <tr>
                    <td><%= d.user_id %></td>
                    <td><%= d.device_type %></td>
                    <td><%= d.device_id %></td>
                    <td><%= d.status %></td>
                    <td><%= d.last_sync ? new Date(d.last_sync).toISOString().replace('T',' ').slice(0,16) : '-' %></td>
                    <td>
                      <form class="d-inline" method="post" action="/admin/wearables/<%= d.device_id %>/disconnect"><button class="btn btn-sm btn-danger" <%= d.status==='disconnected'?'disabled':'' %>>Disconnect</button></form>
                      <form class="d-inline" method="post" action="/admin/wearables/<%= d.device_id %>/reconnect"><button class="btn btn-sm btn-primary">Reconnect</button></form>
                    </td>
                  </tr>
                <% }) %>
              </tbody></table></div>
            </div>
            <div class="tab-pane fade" id="config" role="tabpanel">
              <h5>Device Configuration</h5>
              <form id="wearableConfigForm" method="post" action="/admin/settings/wearables">
                <input type="hidden" name="redirectTo" value="/admin/wearable-management">
                <div class="row mb-3">
                  <div class="col-md-6"><h6>Google Fit Configuration</h6><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="googleFitStatus" name="googleFitStatus" <%= (wearableSettings && wearableSettings.googleFit && wearableSettings.googleFit.enabled) ? 'checked' : '' %>><label class="form-check-label" for="googleFitStatus">Enable Google Fit</label></div><div class="mb-3"><label for="googleFitApiKey" class="form-label">Google Fit API Key</label><input type="text" class="form-control" id="googleFitApiKey" name="googleFitApiKey" value="<%= (wearableSettings && wearableSettings.googleFit && wearableSettings.googleFit.apiKey) ? wearableSettings.googleFit.apiKey : '' %>"></div><div class="mb-3"><label for="googleFitDataTypes" class="form-label">Data Types to Sync</label><div class="form-check"><input class="form-check-input" type="checkbox" id="googleFitHeartRate" name="googleFitHeartRate" <%= (wearableSettings && wearableSettings.googleFit && wearableSettings.googleFit.dataTypes && wearableSettings.googleFit.dataTypes.heartRate) ? 'checked' : '' %>><label class="form-check-label" for="googleFitHeartRate">Heart Rate</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="googleFitSleep" name="googleFitSleep" <%= (wearableSettings && wearableSettings.googleFit && wearableSettings.googleFit.dataTypes && wearableSettings.googleFit.dataTypes.sleep) ? 'checked' : '' %>><label class="form-check-label" for="googleFitSleep">Sleep Quality</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="googleFitActivity" name="googleFitActivity" <%= (wearableSettings && wearableSettings.googleFit && wearableSettings.googleFit.dataTypes && wearableSettings.googleFit.dataTypes.activity) ? 'checked' : '' %>><label class="form-check-label" for="googleFitActivity">Activity</label></div></div></div>
                  <div class="col-md-6"><h6>Apple HealthKit Configuration</h6><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="healthKitStatus" name="healthKitStatus" <%= (wearableSettings && wearableSettings.healthKit && wearableSettings.healthKit.enabled) ? 'checked' : '' %>><label class="form-check-label" for="healthKitStatus">Enable HealthKit</label></div><div class="mb-3"><label for="healthKitApiKey" class="form-label">HealthKit API Key</label><input type="text" class="form-control" id="healthKitApiKey" name="healthKitApiKey" value="<%= (wearableSettings && wearableSettings.healthKit && wearableSettings.healthKit.apiKey) ? wearableSettings.healthKit.apiKey : '' %>"></div><div class="mb-3"><label for="healthKitDataTypes" class="form-label">Data Types to Sync</label><div class="form-check"><input class="form-check-input" type="checkbox" id="healthKitHeartRate" name="healthKitHeartRate" <%= (wearableSettings && wearableSettings.healthKit && wearableSettings.healthKit.dataTypes && wearableSettings.healthKit.dataTypes.heartRate) ? 'checked' : '' %>><label class="form-check-label" for="healthKitHeartRate">Heart Rate</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="healthKitSleep" name="healthKitSleep" <%= (wearableSettings && wearableSettings.healthKit && wearableSettings.healthKit.dataTypes && wearableSettings.healthKit.dataTypes.sleep) ? 'checked' : '' %>><label class="form-check-label" for="healthKitSleep">Sleep Quality</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="healthKitActivity" name="healthKitActivity" <%= (wearableSettings && wearableSettings.healthKit && wearableSettings.healthKit.dataTypes && wearableSettings.healthKit.dataTypes.activity) ? 'checked' : '' %>><label class="form-check-label" for="healthKitActivity">Activity</label></div></div></div>
                </div>
                <div class="mb-3"><label for="syncFrequency" class="form-label">Data Sync Frequency</label><select class="form-select" id="syncFrequency" name="syncFrequency"><option value="hourly" <%= (wearableSettings && wearableSettings.frequency === 'hourly') ? 'selected' : '' %>>Hourly</option><option value="daily" <%= (wearableSettings && wearableSettings.frequency === 'daily') ? 'selected' : '' %>>Daily</option><option value="realtime" <%= (!wearableSettings || wearableSettings.frequency === 'realtime') ? 'selected' : '' %>>Real-Time</option></select></div>
                <button type="submit" class="btn btn-primary">Save Configuration</button>
              </form>
            </div>
            <div class="tab-pane fade" id="status" role="tabpanel">
              <h5>Status & Analytics</h5>
              <div class="row mb-3"><div class="col-md-3"><select class="form-select" id="statusFilter"><option value="">All Devices</option><option value="google-fit">Google Fit</option><option value="healthkit">Apple HealthKit</option></select></div><div class="col-md-3"><a class="btn btn-success w-100" href="/admin/wearables/export<%= (q||type)?('?'+new URLSearchParams({q:q||'',type:type||''}).toString()):'' %>">Export CSV</a></div></div>
              <div class="row"><div class="col-md-6"><h6>Sync Success Rate</h6><div class="chart-container"><canvas id="syncSuccessChart" data-labels='<%- JSON.stringify((charts && charts.syncSuccess && charts.syncSuccess.labels) || []) %>' data-series='<%- JSON.stringify((charts && charts.syncSuccess && charts.syncSuccess.data) || []) %>'></canvas></div></div><div class="col-md-6"><h6>Device Usage Distribution</h6><div class="chart-container"><canvas id="deviceUsageChart" data-labels='<%- JSON.stringify((charts && charts.deviceUsage && charts.deviceUsage.labels) || []) %>' data-series='<%- JSON.stringify((charts && charts.deviceUsage && charts.deviceUsage.data) || []) %>'></canvas></div></div></div>
              <hr>
              <h6>Device Status Summary</h6>
              <div class="row"><div class="col-md-3"><p><strong>Total Connected Devices:</strong> <%= (totals && totals.connected) || 0 %></p></div><div class="col-md-3"><p><strong>Data Points Collected:</strong> <%= (totals && totals.dataPointsCollected) || 0 %></p></div><div class="col-md-3"><p><strong>Sync Success Rate:</strong> <%= (totals && typeof totals.syncSuccessRate === 'number') ? totals.syncSuccessRate : 0 %>%</p></div><div class="col-md-3"><p><strong>Sync Errors:</strong> <%= (totals && totals.syncErrors) || 0 %></p></div></div>
              <div class="table-responsive"><table class="table table-striped"><thead><tr><th>Device Type</th><th>Connected Users</th><th>Data Points</th><th>Sync Success (%)</th><th>Sync Errors</th></tr></thead><tbody>
                <% (deviceSummary || []).forEach(function(row){ %>
                  <tr>
                    <td><%= row.label %></td>
                    <td><%= row.connectedUsers %></td>
                    <td><%= row.dataPoints %></td>
                    <td><%= row.successPercent %>%</td>
                    <td><%= row.errors %></td>
                  </tr>
                <% }) %>
              </tbody></table></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Connect New Device Modal -->
      <div class="modal fade" id="addDeviceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="/admin/wearables/connect">
              <div class="modal-header"><h5 class="modal-title">Connect New Device</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                <div class="mb-3"><label class="form-label">User ID</label><input class="form-control" name="userId" required></div>
                <div class="mb-3"><label class="form-label">Device Type</label><select class="form-select" name="deviceType"><option value="google-fit">Google Fit</option><option value="healthkit">Apple HealthKit</option></select></div>
                <div class="mb-3"><label class="form-label">Device ID</label><input class="form-control" name="deviceId" required></div>
              </div>
              <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Connect</button></div>
            </form>
          </div>
        </div>
      </div>

