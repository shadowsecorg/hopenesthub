<h2>Conversation with <%= otherUser ? otherUser.name : 'User' %></h2>
<div class="card p-3 mb-4">
    <div class="mb-3">
        <a class="btn btn-link p-0" href="/caregiver/messages">&larr; Back to Messages</a>
        <button class="btn btn-primary float-end" data-bs-toggle="modal" data-bs-target="#sendMessageModal">Send New Message</button>
    </div>
    <div class="list-group">
        <% (thread||[]).forEach(m => { %>
        <div class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
                <div class="fw-bold"><%= m.sender && m.sender.id === caregiverId ? 'You' : (m.sender?.name || 'Unknown') %></div>
                <div><%= m.content || '' %></div>
                <small class="text-muted"><%= new Date(m.created_at).toISOString().replace('T',' ').slice(0,16) %></small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-danger" title="Delete" onclick="deleteMessage(<%= m.id %>, true)"><i class="bi bi-trash"></i></button>
            </div>
        </div>
        <% }) %>
    </div>

    <form class="mt-3" id="replyForm" onsubmit="return sendReply(event)">
        <input type="hidden" id="threadRecipient" value="<%= otherUser ? otherUser.id : '' %>">
        <div class="input-group">
            <input type="text" class="form-control" id="replyContent" placeholder="Type your message..." required>
            <button class="btn btn-primary" type="submit">Send</button>
        </div>
    </form>
</div>

<script>
async function deleteMessage(id, stay) {
    if (!confirm('Are you sure you want to delete this message?')) return;
    try {
        const res = await fetch(`/caregiver/messages/${id}/delete`, { method: 'POST' });
        if (res.ok) {
            if (stay) location.reload(); else location.href = '/caregiver/messages';
        } else { alert('Delete failed'); }
    } catch (e) { alert('Delete failed'); }
}

async function sendReply(e) {
    e.preventDefault();
    const recipient = document.getElementById('threadRecipient').value;
    const content = document.getElementById('replyContent').value;
    if (!recipient || !content) return false;
    try {
        await fetch('/caregiver/messages/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ recipient, content }) });
        document.getElementById('replyContent').value = '';
        location.reload();
    } catch (e) { alert('Failed to send'); }
    return false;
}
</script>


